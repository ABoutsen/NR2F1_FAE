library(Seurat)

#### Sample Identification and Data Import ####
# Define sample identifiers corresponding to biological conditions.
samples <- c("control_1", "control_2", "control_3", "etoh_1", "etoh_2", "etoh_3")

# Specify the file paths to the filtered feature-barcode matrices generated by 10x Genomics Cell Ranger pipeline.
feature_matrix_paths <- c(
  "../../fc1_filtered_feature_bc_matrix/",
  "../../fc2_filtered_feature_bc_matrix/",
  "../../fc3_filtered_feature_bc_matrix/",
  "../../fe1_filtered_feature_bc_matrix/",
  "../../fe2_filtered_feature_bc_matrix/",
  "../../fe3_filtered_feature_bc_matrix/"
)

# Assign sample type metadata corresponding to treatment groups.
sample_types <- c(rep("Ctrl", 3), rep("EtOH", 3))

# Initialize a list to store Seurat objects for each individual sample.
seurat_list <- list()


# Loop over each sample to read count matrices and create Seurat objects.
for (i in seq_along(samples)) {
  message(sprintf("Reading sample %d: %s from %s", i, samples[i], feature_matrix_paths[i]))
  
  # Read filtered feature-barcode matrix using Read10X function.
  counts <- Read10X(data.dir = feature_matrix_paths[i])
  
  message(sprintf("Creating Seurat object for sample %s with min.features = 350 and min.cells = 3", samples[i]))
  
  # Create Seurat object with standard quality thresholds to include cells with
  # a minimum of 350 detected features and features expressed in at least 3 cells.
  seurat_obj <- CreateSeuratObject(counts = counts, project = samples[i], min.features = 350, min.cells = 3)
  
  # Annotate each Seurat object with experimental group metadata for downstream stratified analyses.
  seurat_obj$type <- sample_types[i]
  
  # Store the individual Seurat object in the list for later merging.
  seurat_list[[samples[i]]] <- seurat_obj
}

#### Data Integration ####
# Merge individual Seurat objects into a single combined object to facilitate comparative analysis.
combined_seurat <- merge(seurat_list[[1]], y = seurat_list[-1],
                         add.cell.ids = samples, project = "scRNA")

#### Quality Control (QC) Metrics Calculation ####
# Compute percentage of mitochondrial gene expression as an indicator of cell quality.
combined_seurat <- PercentageFeatureSet(combined_seurat, pattern = "^mt-", col.name = "percent.mt")

# Compute percentage of hemoglobin gene expression to identify potential contamination or erythrocyte presence.
combined_seurat <- PercentageFeatureSet(combined_seurat, pattern = "^Hbb-", col.name = "percent.hbb")

# Compute percentage of ribosomal protein gene expression as a proxy for translational activity.
combined_seurat <- PercentageFeatureSet(combined_seurat, pattern = "^Rps|^Rpl", col.name = "percent.ribo")

#### Visualization of QC Metrics Prior to Filtering ####
# Violin plots to visualize distribution of detected features, counts, and mitochondrial content across cells.
VlnPlot(combined_seurat, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

# Scatter plots to visualize relationships between total counts, features, and mitochondrial percentage,
# enabling identification of potential outliers or low-quality cells.
plot1 <- FeatureScatter(combined_seurat, feature1 = "nCount_RNA", feature2 = "percent.mt") + NoLegend()
plot2 <- FeatureScatter(combined_seurat, feature1 = "nFeature_RNA", feature2 = "percent.mt") + NoLegend()
plot3 <- FeatureScatter(combined_seurat, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot1 + plot2 + plot3

#### Cell Filtering Based on QC Metrics ####
# Subset the dataset to retain high-quality cells based on pre-defined thresholds for
# feature counts, total RNA counts, and mitochondrial gene percentage to reduce technical noise.
combined_seurat <- subset(combined_seurat, subset = nFeature_RNA > 1000 & nFeature_RNA < 6000 &
                            nCount_RNA > 450 & nCount_RNA < 35000 &
                            percent.mt < 15)

#### Cell Cycle Scoring ####
# Import curated lists of S phase and G2/M phase marker genes for cell cycle phase assignment.
s_genes <- unlist(read.table("../Data For Analysis/s_genes.txt", header = TRUE), use.names = FALSE)
g2m_genes <- unlist(read.table("../Data For Analysis/g2m_genes.txt", header = TRUE), use.names = FALSE)

# Perform cell cycle scoring to classify cells by cell cycle phase based on gene expression signatures.
combined_seurat <- CellCycleScoring(combined_seurat, s.features = s_genes, g2m.features = g2m_genes)

# Compute difference between S and G2/M scores as an additional cell cycle metric.
combined_seurat$CC.Difference <- combined_seurat$S.Score - combined_seurat$G2M.Score

# Visualize cell cycle phase scores stratified by original sample identity.
VlnPlot(combined_seurat, features = c("S.Score", "G2M.Score", "CC.Difference"),
        group.by = "orig.ident", ncol = 3, pt.size = 0.1)

#### Sex Chromosome Gene Expression Quantification ####
# Define lists of genes located on the Y and X chromosomes to quantify sex-specific expression.
chrY_genes <- c("Uba1y", "Gm28587", "Kdm5d", "Eif2s3y", "Gm29650", "Uty", "Ddx3y", "Gm21860", "Gm47283")
chrX_genes <- c("Xist", "Tsix")

# Calculate percentage of reads mapping to Y chromosome genes per cell.
combined_seurat$pct_chrY <- colSums(combined_seurat@assays$RNA@counts[chrY_genes, ]) / colSums(combined_seurat@assays$RNA@counts)

# Calculate percentage of reads mapping to X chromosome genes per cell.
combined_seurat$pct_chrX <- colSums(combined_seurat@assays$RNA@counts[chrX_genes, ]) / colSums(combined_seurat@assays$RNA@counts)

# Add module scores for X and Y chromosome gene sets to enable downstream analysis of sex-related effects.
combined_seurat <- AddModuleScore(combined_seurat, features = list(chrY_genes), name = "Y")
combined_seurat <- AddModuleScore(combined_seurat, features = list(chrX_genes), name = "X")

#### Visualization of QC Metrics Post-Filtering ####
VlnPlot(combined_seurat, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

plot1 <- FeatureScatter(combined_seurat, feature1 = "nCount_RNA", feature2 = "percent.mt") + NoLegend()
plot2 <- FeatureScatter(combined_seurat, feature1 = "nFeature_RNA", feature2 = "percent.mt") + NoLegend()
plot3 <- FeatureScatter(combined_seurat, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot1 + plot2 + plot3

#### Normalization and Scaling ####
# Normalize and variance-stabilize expression data using SCTransform, regressing out
# potential confounders such as sex chromosome expression and mitochondrial/hemoglobin content.
combined_seurat <- SCTransform(combined_seurat,
                               vars.to.regress = c("pct_chrX", "pct_chrY", "percent.hbb", "percent.mt"),
                               verbose = TRUE)

#### Dimensionality Reduction by Principal Component Analysis (PCA) ####
# Identify the principal components capturing the largest sources of variation in the dataset.
combined_seurat <- RunPCA(combined_seurat, features = VariableFeatures(combined_seurat), verbose = FALSE)

# Visualize gene loadings on principal components 1 and 2 to interpret biological drivers.
VizDimLoadings(combined_seurat, dims = 1:2, reduction = "pca")

# Generate 2D PCA scatterplot and heatmap to inspect global data structure.
DimPlot(combined_seurat, reduction = "pca")
DimHeatmap(combined_seurat, dims = 1:25, cells = 500, balanced = TRUE)

# Elbow plot to determine the optimal number of principal components for downstream analysis.
ElbowPlot(combined_seurat, ndims = 50)

#### Clustering and Visualization with UMAP ####
# Construct nearest-neighbor graph and perform unsupervised clustering using Louvain algorithm.
combined_seurat <- FindNeighbors(combined_seurat, dims = 1:25)
combined_seurat <- FindClusters(combined_seurat, resolution = 0.2)

# Rename clusters with numeric IDs for clarity in visualization.
new_cluster_ids <- setNames(seq_along(levels(Idents(combined_seurat))), levels(Idents(combined_seurat)))
combined_seurat <- RenameIdents(combined_seurat, new_cluster_ids)

# Run UMAP to visualize high-dimensional data in two-dimensional space.
combined_seurat <- RunUMAP(combined_seurat, dims = 1:25, reduction.name = "umap.25")

# Generate UMAP plot with cluster labels.
DimPlot(combined_seurat, label = TRUE, reduction = "umap.25")

